<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OMCompilerDoxygen: ZeroMQ on z/OS UNIX System Services</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OMCompilerDoxygen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">ZeroMQ on z/OS UNIX System Services </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>ZeroMQ has been successfully built on z/OS, using <a href="http://www-03.ibm.com/systems/z/os/zos/features/unix/">z/OS UNIX System Services</a>, a certified UNIX environment for the <a href="http://www-03.ibm.com/systems/z/">IBM z-series</a>. The build is possible with the shell scripts in this directory, as described below.</p>
<p>Tested build combinations:</p>
<ul>
<li>ZeroMQ 4.0.4, using IBM XL C/C++ compiler, as XPLINK in ILP32 mode</li>
<li>ZeroMQ 4.0.4, using IBM XL C/C++ compiler, as XPLINK in LP64 mode</li>
<li>ZeroMQ 4.1-git, using IBM XL C/C++ compiler, as XPLINK in ILP32 mode</li>
</ul>
<p>Other combinations are likely to work, possibly with minor changes, but have not been tested. Both static library and DLL modes have been tested.</p>
<p>There are some minor limitations (detailed below), but all core functionality tests run successfully.</p>
<h2>Quickstart: building ZeroMQ on z/OS UNIX System Services</h2>
<p>Assuming <a href="http://www-03.ibm.com/systems/z/os/zos/features/unix/">z/OS UNIX System Services</a> is installed, and the <a href="http://www-03.ibm.com/software/products/en/czos">z/OS XL C/C++ compiler suite</a> is installed, ZeroMQ can be built as follows:</p>
<ul>
<li>Download and extract ZeroMQ tar file</li>
<li>Ensure contents of this directory are present at <code>builds/zos</code> within that extracted diretory (eg, <code>zeromq-VERSION/builds/zos/</code>; copy these files in, if not already present, and make sure the shell scripts are executable)</li>
<li>(Optional) set ZCXXFLAGS for additional compile flags (see below)</li>
<li><p class="startli">Build <code>libzmq.a</code> static library and <code>libzmq.so</code> dynamic library, with: </p><pre class="fragment">cd zeromq-VERSION
builds/zos/makelibzmq
</pre><p class="startli">or to skip the <code>libzmq.so</code> dynamic library (only building <code>libzmq.a</code>): </p><pre class="fragment">cd zeromq-VERSION
BUILD_DLL=false
export BUILD_DLL
builds/zos/makelibzmq
</pre></li>
<li>(Optional, but recommended) build and run the core tests with: <pre class="fragment">cd zeromq-VERSION
builds/zos/maketests
builds/zos/runtests
</pre></li>
<li>To remove built files, to start again (eg, rebuild with different compile/link flags): <pre class="fragment">cd zeromq-VERSION
builds/zos/makeclean
</pre></li>
</ul>
<p>There are details on specifying alternative compilation flags below.</p>
<h2>Quickstart: using ZeroMQ on z/OS UNIX System Services</h2>
<h3>Static linking</h3>
<p>Install <code>include/*.h</code> somewhere on your compiler include path.</p>
<p>Install <code>src/libzmq.a</code> somewhere on your library search path.</p>
<p>Compile and link application with: </p><pre class="fragment">c++ -Wc,xplink -Wl,xplink ... -+ -o myprog myprog.cpp -lzmq
</pre><p>Run with: </p><pre class="fragment">./myprog
</pre><h3>Dynamic linking</h3>
<p>Install <code>include/*.h</code> somewhere on your compiler include path.</p>
<p>Install <code>src/libzmq.so</code> somewhere on your LIBPATH.</p>
<p>Install <code>src/libzmq.x</code> somewhere you can reference for import linking.</p>
<p>Compile and link application: </p><pre class="fragment">c++ -Wc,xplink -Wc,dll ... -+ -c -o myprog.o myprog.cpp
c++ -Wl,xplink -o myprog myprog.o /PATH/TO/libzmq.x
</pre><p>Run with: </p><pre class="fragment">LIBPATH=/DIR/OF/LIBZMQ.SO:/lib:/usr/lib:...    # if not in default path
export LIBPATH
./myprog
</pre><h2>ZeroMQ on z/OS UNIX System Services: Application considerations</h2>
<p>z/0S UNIX System Services does not provide a way to block the <a href="http://pic.dhe.ibm.com/infocenter/zvm/v6r2/index.jsp?topic=%2Fcom.ibm.zos.r12.cbcpx01%2Fcbcpg1b0287.htm"><code>SIGPIPE</code> signal being generated when a thread writes to a closed socket</a> (compare with other platforms that support the <code>SO_NOSIGPIPE</code> socket option, and/or the <code>MSG_NOSIGNAL</code> flag on <code><a class="el" href="../../d3/dc8/class_teuchos_1_1_comm.html#a4b4a833972f7b5ca681f0993f9ed7222" title="Send objects that use values semantics to another process. ">send()</a></code>; z/OS UNIX System Services supports neither).</p>
<p>As a result, applications using ZeroMQ on z/OS UNIX System Services have to expect to encounter <code>SIGPIPE</code> at various times during the use of the library, if sockets are unexpectedly disconnected. Normally <code>SIGPIPE</code> will terminate the application.</p>
<p><a class="el" href="../../d8/d4f/class_a.html">A</a> simple solution, if <code>SIGPIPE</code> is not required for normal operation of the application (eg, it is not part of a unix pipeline, the traditional use of <code>SIGPIPE</code>), is to set <code>SIGPIPE</code> to be ignored with code like: </p><pre class="fragment">#include &lt;signal.h&gt;
...
signal(SIGPIPE, SIG_IGN);
</pre><p>near the start of the application (eg, before initialising the ZeroMQ library).</p>
<p>If <code>SIGPIPE</code> is required for normal operation it is recommended that the application install a signal handler that flags the signal was received, and allows the application main loop to determine if it was received for one of its own file descriptors &ndash; and ignores it if it none of the applications own file descriptors seems to have changed.</p>
<p>Linking to the <code>libzmq.a</code> static library will pull in substantially all of the library code, which will add about 4MB to the application size (per executable statically linked with ZeroMQ). If this is a significant consideration, use of the DLL version is recommended.</p>
<p>See also ZeroMQ test status on z/OS UNIX System Services below for other caveats.</p>
<h2>Setting other compilation flags</h2>
<h3>Optimisation</h3>
<p>To build with optimisation:</p>
<ul>
<li>set <code>ZCXXFLAGS</code> to "`-O2`" before starting build process above</li>
</ul>
<h3>Full debugging symbols</h3>
<p>To build with debugging symbols:</p>
<ul>
<li>set <code>ZCXXFLAGS</code> to "`-g`" before starting build process above</li>
</ul>
<h3>64-bit mode (LP64/amode=64)</h3>
<p>To build in 64-bit mode:</p>
<p>The default build is <a href="http://publib.boulder.ibm.com/infocenter/zvm/v6r1/index.jsp?topic=/com.ibm.zos.r9.cbcux01/lp64cop.htm">ILP32</a>, the default for the IBM XL C/C++ compiler. To build in LP64 mode (64-bit):</p>
<ul>
<li>set <code>ZCXXFLAGS</code> to "`-Wc,lp64 -Wl,lp64`" before starting build</li>
</ul>
<p>(64-bit mode can be combined with optimisation or debug symbols.)</p>
<h3>Combining compilation flags</h3>
<p>Other build flags can be used in <code>ZXCCFLAGS</code> if desired. Beware that they are passed through (Bourne) shell expansion, and passed to both the compile and link stages; some experimentation of argument quoting may be required (and arguments requiring parenthesis are particularly complicated).</p>
<h2>ZeroMQ test status on z/OS UNIX System Services</h2>
<p>As of 2014-07-22, 41 of the 43 tests in the core ZeroMQ test suite pass. There are two tests that are expected to fail:</p>
<p>0. <code>test_abstract_ipc</code>: tests Linux-specific IPC functions, and is expected to fail on non-Linux platforms.</p>
<p>0. <code>test_fork</code>: tests ability to use ZeroMQ both before <em>and</em> after fork (and before exec()); this relies on the ability to use pthreads both before <em>and</em> after fork. On z/OS (and some other UNIX compliant platforms) functions like <code>pthreads_create</code> (used by ZeroMQ) cannot be used after fork and before exec; on z/OS the call after fork fails with <code>ELEMULTITHREADFORK</code> (errno=257) if ZeroMQ was also used before fork. (On z/OS it appears possible to use z/OS <em>after</em> fork, <em>providing</em> it has not been used before fork &ndash; the problem is the two separate initialisations of the threading library, before and after fork, attempting to mix together.) In practice this is unlikely to affect many real-world programs &ndash; most programs use threads or fork without exec, but not both.</p>
<p>0. <code>test_diffserv</code>: tests ability to set IP_TOS (<a href="http://en.wikipedia.org/wiki/Type_of_service">IP Type of Service</a>, or <a href="http://en.wikipedia.org/wiki/Differentiated_Services_Code_Point">DiffServ</a>) values on sockets. While z/OS UNIX System Services has the preprocessor defines required, it appears not to support the required functionality (call fails with "EDC8109I Protocol not
    available.")</p>
<p>These three "expected to fail" tests are listed as XFAIL_TESTS, and <code>runtests</code> will still consider the test run successful when they fail as expected. (<code>builds/zos/runtests</code> will automatically skip these "expected to fail" tests if running "all" tests.)</p>
<p>In addition <code>test_security_curve</code> does not do any meaningful testing, as a result of the CURVE support not being compiled in; it requires <a href="http://doc.libsodium.org/"><code>libsodium</code></a>, which has not been ported to z/OS UNIX System Services yet.</p>
<p>Multicast (via <code>libpgm</code>) is also not ported or compiled in.</p>
<p><a href="http://hintjens.com/blog:70">TIPC</a>, a cluster IPC protocol, is only supported on Linux, so it is not compiled into the z/OS UNIX System Services port &ndash; and the tests are automatically skipped if running "all" tests. (However they are not listed in XFAIL_TESTS because without the TIPC support there is no point in even running them, and it would be non-trivial to track them by hand.)</p>
<h2>ZeroMQ on z/OS UNIX System Services: Library portability notes</h2>
<h3>*.cpp</h3>
<p>The source code in ZeroMQ is a combination of a C++ core library (in <code>*.cpp</code> and <code>*.hpp</code> files), and a <a class="el" href="../../dd/de0/class_c.html">C</a> wrapper (also in <code>*.cpp</code> files). It is all compiled with the C++ compiler. The IBM XL C/C++ complier (at least the version used for initial porting) insists that C++ source be in <code>*.<a class="el" href="../../dd/de0/class_c.html">C</a></code> files (note capital <a class="el" href="../../dd/de0/class_c.html">C</a>). To work around this issue the compile flag <code>-+</code> is used (specified in the <code>zc++</code> compiler wrapper), which tells the compiler the file should be considered C++ despite the file extension.</p>
<h3>XPLINK</h3>
<p>The library (and tests) are built in <a href="http://www.redbooks.ibm.com/abstracts/sg245991.html">XPLINK</a> mode with the flags <code>-Wc,xplink -Wl,xplink</code> (specified in the <code>zc++</code> compiler wrapper). This is <a href="http://publib.boulder.ibm.com/infocenter/zvm/v5r4/index.jsp?topic=/com.ibm.zos.r9.ceea200/xplrunt.htm">recommended by IBM for C++ code</a> due to the small functions. (Amongst other things, using XPLINK enables function calls with some arguments passed in registers.)</p>
<h3>long long</h3>
<p>ZeroMQ makes use of <code>uint64_t</code> (which is <code>unsigned long long</code> in ILP32 mode). To enable this the compile flag <code>-Wc,lang(longlong)</code> is passed to enable <code>long long</code>. This is passed from the <code>zc++</code> compiler wrapper in order to be able to specifically quote the argument to protect the parentheses from shell expansion.</p>
<h3>BSD-style sockets, with IPv6 support</h3>
<p>ZeroMQ uses BSD-style socket handling, with extensions to support IPv6. BSD-style sockets were merged into SysV-derived UNIX at least a decade ago, and are required as part of the X/Open Portability Guide at least as of XPG 4.2. To access this functionality two feature macros are defined: </p><pre class="fragment">_XOPEN_SOURCE_EXTENDED=1

_OPEN_SYS_SOCK_IPV6
</pre><p>The first enables the XPG 4.2 features (including functionality like <code>getsockname()</code>), and the latter exposes IPv6 specific functionality like <code>sa_family_t</code>. These flags are defined in the <code>cxxall</code> script.</p>
<p>(The traditional BSD-sockets API, exposed with <code>_OE_SOCKETS</code> cannot be used because it does not support functions like <code>getsockname()</code>, nor does it support IPv6 &ndash; and the API definitions prevent compiling in LP64 mode due to assumptions about long being 32 bits. Using <code>_XOPEN_SOURCE_EXTENDED=1</code> avoids all these problems.)</p>
<h3>pthreads</h3>
<p>ZeroMQ uses the pthreads library to create additional threads to handle background communication without blocking the main application. This functionaity is enabled on z/OS UNIX System Services by defining: </p><pre class="fragment">_OPEN_THREADS=3
</pre><p>which is done in the <code>cxxall</code> script. (The "3" value exposes later pthreads functionality like <code>pthread_atfork</code>, although ZeroMQ does not currently use all these features.)</p>
<p>If compiling on a <em>recent</em> version of z/OS UNIX System Services it may be worth compiling with: </p><pre class="fragment">_UNIX03_THREADS=1
</pre><p>which enables a later version of the threading support, potentially including <code>pthread_getschedparam</code> and pthread_setschedparam`; at present in the z/OS UNIX System Services port these functions are hidden and never called. (See <a href="http://pic.dhe.ibm.com/infocenter/zos/v1r11/index.jsp?topic=/com.ibm.zos.r11.bpxbd00/pthrdh.htm">IBM z/OS pthread.h documentation</a> for details on the differences.)</p>
<h2><code>platform.hpp</code> on z/OS UNIX System Services</h2>
<p>The build (described above) on z/OS UNIX System Services uses a static pre-built <code>platform.hpp</code> file. (By default <code>src/platform.hpp</code> is dynamically generated as a result of running the <code>./configure</code> script.) The master version of this is in <code><a class="el" href="../../db/d32/_2zos_2platform_8hpp.html">builds/zos/platform.hpp</a></code>.</p>
<p>Beware that this file contains the version number for libzmq (usually included during the configure phase). If taking the <code>platform.hpp</code> from an older version to use on a newer libzmq be sure to update the version information near the top of the file.</p>
<p>The pre-built file is used because z/OS does not have the GNU auto tools (<code>automake</code>, <code>autoconf</code>, <code>libtool</code>, etc) installed, and particularly the libtool replacement does not work properly with the IBM XL C/C++ compiler.</p>
<p>The <code>./configure</code> script (only supplied in the tarballs); built with <code>automake</code> and <code>autoconf</code> on another platform), with one small edit, was used to generate the z/OS <code>platform.hpp</code> and then two small changes (described below) were made by hand to the generated <code>platform.hpp</code>.</p>
<p>To be able to run the ./configure script to completion (in tcsh syntax):</p>
<ul>
<li><p class="startli">Edit <code>./configure</code> and add: </p><pre class="fragment">openedition)
      ;;
</pre><p class="startli">immediately before the line: </p><pre class="fragment">as_fn_error $? "unsupported system: ${host_os}." "$LINENO" 5
</pre><p class="startli">(somewhere around 17637). This avoids the configure script giving up early because <code>openedition</code> is not recognised.</p>
</li>
<li>set <code>CXX</code> to point that the full path to the <code>builds/zos/zc++</code> wrapper, eg <pre class="fragment">setenv CXX "/u/0mq/zeromq-4.0.4/builds/zos/zc++"
</pre></li>
<li>set <code>CPPFLAGS</code> to for the feature macros required, eg: <pre class="fragment">setenv CPPFLAGS "-D_XOPEN_SOURCE_EXTENDED=1 -D_OPEN_THREADS=3 -D_OPEN_SYS_SOCK_IPV6 -DZMQ_HAVE_ZOS"
</pre></li>
<li>set <code>CXXFLAGS</code> to enable XPLINK: <pre class="fragment">setenv CXXFLAGS "-Wc,xplink -Wl,xplink -+"
</pre></li>
<li>run configure script with <code>--disable-eventfd</code> (<code>sys/eventfd.h</code> does not exist, but the test for its existance has a false positive on z/OS UNIX System Services, apparently due to the way the <code>c++</code> compiler wrapper passes errors back from the IBM XL C/C++ compiler), and with <code>--with-poller=poll</code> because <code>poll</code> is the most advanced of the file descriptor status tests available on z/OS. That is: <pre class="fragment">./configure --disable-eventfd --with-poller=poll
</pre></li>
</ul>
<p>All going well several Makefiles, and <code>src/platform.hpp</code> should be produced. Two additional changes are required to <code>src/platform.hpp</code> which can be appended to the end: </p><pre class="fragment">/* ---- Special case for z/OS Unix Services: openedition ---- */
#include &lt;pthread.h&gt;
#ifndef   NI_MAXHOST
#define   NI_MAXHOST 1025
#endif
</pre><p>(many includes require pthreads-related methods or data structures to be defined, but not all of them include <code>pthread.h</code>, and the value <code>NI_MAXHOST</code> is not defined on z/OS UNIX System Services &ndash; the 1025 value is the conventional value on other platforms).</p>
<p>Having done this the Makefiles can be used to compile individual files if desired, eg: </p><pre class="fragment">cd src
make zmq.o
</pre><p>but note:</p>
<ul>
<li>IBM Make will warn of duplicate prerequisites on <em>every</em> run of <code>make</code>, and both the generated <code>src/Makefile</code> and <code>tests/Makefile</code> have several duplicates. (For <code>src/Makefile</code> edit <code>libzmq_la_SOURCES</code> to remove the duplicates.)</li>
<li>IBM Make does not understand the <code>@</code> prefix (eg, <code>@echo</code>) as a way to avoid echoing the command, resulting in an error and the command being echoed anyway.</li>
<li>Many of the make targets result in GNU auto tools (<code>aclocal</code>, etc) being invoked, which are likely to fail, and most of the library-related targets will invoke <code>libtool</code> which will cause compile failures (due to differences in expected arguments).</li>
</ul>
<p>However running <code>./configure</code> to regenerate <code>src/platform.hpp</code> may be useful for later versions of ZeroMQ which add more feature tests.</p>
<h2>Transferring from GitHub to z/OS UNIX System Services</h2>
<p>The process of transferring files from GitHub to z/OS UNIX System Services is somewhat convoluted because:</p>
<ul>
<li>There is not a port of git for z/OS UNIX System Services; and</li>
<li>z/OS uses the EBCDIC (IBM-1047) character set rather than the ASCII/ISO-8859-1 character set used by the ZeroMQ source code on GitHub</li>
</ul>
<p><a class="el" href="../../d8/d4f/class_a.html">A</a> workable transfer process is:</p>
<ul>
<li>On an ASCII/ISO-8859-1/UTF-8 system with <code>git</code> (eg, a Linux system): <pre class="fragment">git clone https://github.com/zeromq/libzmq.git
git archive --prefix=libzmq-git/ -o /var/tmp/libzmq-git.tar master
</pre></li>
<li>On a ASCII/ISO-8859-1/UTF-8 system with <code>tar</code>, and <code>pax</code>, and optionally the GNU auto tools (eg, the same Linux system): <pre class="fragment">mkdir /var/tmp/zos
cd /var/tmp/zos
tar -xpf /var/tmp/libzmq-git.tar
cd libzmq-git
./autogen.sh             # Optional: to be able to run ./configure
cd ..
pax -wf /var/tmp/libzmq-git.pax libzmq-git
compress libzmq-git.pax  # If available, reduce transfer size
</pre></li>
<li>Transfer the resulting file (<code>libzmq-git.pax</code> or <code>libzmq-git.pax.Z</code>) to the z/OS UNIX System Services system. If using FTP be sure to transfer the file in <code>bin</code> (binary/Image) mode to avoid corruption.</li>
<li><p class="startli">On the z/OS UNIX System Services system, unpack the <code>pax</code> file and convert all the files to EBCDIC with: </p><pre class="fragment">pax -o from=iso8859-1 -pp -rvf  libzmq-git-2014-07-23.pax
</pre><p class="startli">or if the file was compressed: </p><pre class="fragment">pax -o from=iso8859-1 -pp -rvzf libzmq-git-2014-07-23.pax.Z
</pre></li>
</ul>
<p>The result should be a <code>libzmq-git</code> directory with the source in EBCDIC format, on the z/OS UNIX System Services system ready to start building.</p>
<p>See also the <a href="http://pic.dhe.ibm.com/infocenter/zos/v1r13/index.jsp?topic=%2Fcom.ibm.zos.r13.bpxa500%2Fr4paxsh.htm"><code>pax</code> man page</a>, some <a href="http://pic.dhe.ibm.com/infocenter/zos/v1r13/index.jsp?topic=%2Fcom.ibm.zos.r13.bpxa400%2Fbpxza4c0291.htm"><code>pax</code> conversion examples</a>, and <a href="http://www-03.ibm.com/systems/z/os/zos/features/unix/bpxa1p03.html">IBM's advice on ASCII to EBCDIC conversion options</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
